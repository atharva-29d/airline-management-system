<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- Flash Messages -->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="fixed top-4 right-4 z-50 space-y-2">
      {% for msg in messages %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-lg">
          {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="flex h-screen">

    <!-- Sidebar -->
    <div class="w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white shadow-2xl">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <span class="text-3xl">üë®‚Äçüíº</span>
                <div>
                    <h1 class="text-xl font-bold">Admin Panel</h1>
                    <p class="text-xs text-gray-400">{{ admin.full_name }}</p>
                </div>
            </div>
        </div>

        <nav class="mt-6">
            <a href="#" id="dashboardLink" class="sidebar-link active flex items-center px-6 py-3 hover:bg-gray-700 transition">
                <span class="mr-3">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="#" id="flightsLink" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700 transition">
                <span class="mr-3">‚úàÔ∏è</span>
                <span>Manage Flights</span>
            </a>
            <a href="#" id="bookingsLink" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700 transition">
                <span class="mr-3">üé´</span>
                <span>All Bookings</span>
            </a>
            <a href="#" id="usersLink" class="sidebar-link flex items-center px-6 py-3 hover:bg-gray-700 transition">
                <span class="mr-3">üë•</span>
                <span>Manage Users</span>
            </a>
            <a href="{{ url_for('admin_logout') }}" class="sidebar-link flex items-center px-6 py-3 hover:bg-red-700 transition mt-8">
                <span class="mr-3">üö™</span>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto">

        <!-- Header -->
        <div class="bg-white shadow-md p-6">
            <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
            <p class="text-gray-600">Welcome back, {{ admin.full_name }}</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="p-6">

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Total Flights -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-blue-100 text-sm">Total Flights</p>
                            <h3 class="text-4xl font-bold mt-2">{{ stats.total_flights }}</h3>
                        </div>
                        <span class="text-5xl opacity-50">‚úàÔ∏è</span>
                    </div>
                </div>

                <!-- Total Bookings -->
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-green-100 text-sm">Total Bookings</p>
                            <h3 class="text-4xl font-bold mt-2">{{ stats.total_bookings }}</h3>
                        </div>
                        <span class="text-5xl opacity-50">üé´</span>
                    </div>
                </div>

                <!-- Total Revenue -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-purple-100 text-sm">Total Revenue</p>
                            <h3 class="text-4xl font-bold mt-2">‚Çπ{{ "{:,.0f}".format(stats.total_revenue) }}</h3>
                        </div>
                        <span class="text-5xl opacity-50">üí∞</span>
                    </div>
                </div>

                <!-- Total Users -->
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-red-100 text-sm">Total Users</p>
                            <h3 class="text-4xl font-bold mt-2">{{ stats.total_users }}</h3>
                        </div>
                        <span class="text-5xl opacity-50">üë•</span>
                    </div>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Bookings</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600">PNR</th>
                                <th class="text-left py-3 px-4 text-gray-600">Passenger</th>
                                <th class="text-left py-3 px-4 text-gray-600">Flight</th>
                                <th class="text-left py-3 px-4 text-gray-600">Airline</th>
                                <th class="text-left py-3 px-4 text-gray-600">Date</th>
                                <th class="text-left py-3 px-4 text-gray-600">Amount</th>
                                <th class="text-left py-3 px-4 text-gray-600">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in recent_bookings %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4 font-semibold text-red-600">{{ booking.pnr }}</td>
                                <td class="py-3 px-4">{{ booking.passenger_name }}</td>
                                <td class="py-3 px-4">{{ booking.flight_no }}</td>
                                <td class="py-3 px-4">{{ booking.airline }}</td>
                                <td class="py-3 px-4 text-sm text-gray-600">{{ booking.booking_date.strftime('%d %b %Y') }}</td>
                                <td class="py-3 px-4 font-semibold">‚Çπ{{ "{:,.0f}".format(booking.price) }}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 text-xs rounded-full
                                        {% if booking.status == 'Confirmed' %}bg-green-100 text-green-800
                                        {% elif booking.status == 'Cancelled' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ booking.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Manage Flights Content -->
        <!-- Manage Flights Content -->
<div id="flightsContent" class="hidden p-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Manage Flights</h3>
            <div class="flex gap-3">
                <input type="text" id="flightSearch" placeholder="Search flights..."
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="loadFlights()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="flightsTable" class="overflow-x-auto">
            <p class="text-center text-gray-500 py-8">Loading flights...</p>
        </div>
    </div>
</div>

        <!-- All Bookings Content -->
        <!-- All Bookings Content -->
<div id="bookingsContent" class="hidden p-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">All Bookings</h3>
            <div class="flex gap-3">
                <input type="text" id="bookingSearch" placeholder="Search by PNR or name..."
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="loadAllBookings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="bookingsTable" class="overflow-x-auto">
            <p class="text-center text-gray-500 py-8">Loading bookings...</p>
        </div>
    </div>
</div>

        <!-- Manage Users Content -->
        <!-- Manage Users Content -->
<div id="usersContent" class="hidden p-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Manage Users</h3>
            <div class="flex gap-3">
                <input type="text" id="userSearch" placeholder="Search users..."
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="loadUsers()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="usersTable" class="overflow-x-auto">
            <p class="text-center text-gray-500 py-8">Loading users...</p>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">User Details</h3>
            <button onclick="closeUserModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="userModalContent"></div>
    </div>
</div>

    </div>
</div>

<script>
    // Sidebar navigation
    const sections = {
        dashboardLink: 'dashboardContent',
        flightsLink: 'flightsContent',
        bookingsLink: 'bookingsContent',
        usersLink: 'usersContent'
    };

    Object.keys(sections).forEach(linkId => {
        document.getElementById(linkId).addEventListener('click', (e) => {
            e.preventDefault();

            // Hide all sections
            Object.values(sections).forEach(sec => {
                document.getElementById(sec).classList.add('hidden');
            });

            // Show selected section
            document.getElementById(sections[linkId]).classList.remove('hidden');

            // Update active link
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active', 'bg-gray-700');
            });
            document.getElementById(linkId).classList.add('active', 'bg-gray-700');

            // Load data for the section
            if (linkId === 'flightsLink') loadFlights();
            if (linkId === 'bookingsLink') loadAllBookings();
            if (linkId === 'usersLink') loadUsers();
        });
    });

    // ==================== MANAGE FLIGHTS ====================
    async function loadFlights() {
        const container = document.getElementById('flightsTable');
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Loading flights...</p>';

        try {
            const response = await fetch('/admin/api/flights');
            const flights = await response.json();

            if (!flights.length) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No flights found</p>';
                return;
            }

            let html = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4">Flight No</th>
                            <th class="text-left py-3 px-4">Airline</th>
                            <th class="text-left py-3 px-4">Route</th>
                            <th class="text-left py-3 px-4">Departure</th>
                            <th class="text-left py-3 px-4">Duration</th>
                            <th class="text-left py-3 px-4">Seats (E/B/F)</th>
                            <th class="text-left py-3 px-4">Price (Economy)</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            flights.forEach(f => {
                const depTime = new Date(f.departure_time).toLocaleString('en-IN');
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4 font-semibold text-red-600">${f.flight_no}</td>
                        <td class="py-3 px-4">${f.airline}</td>
                        <td class="py-3 px-4">${f.source_city} ‚Üí ${f.dest_city}</td>
                        <td class="py-3 px-4 text-xs">${depTime}</td>
                        <td class="py-3 px-4">${f.duration} min</td>
                        <td class="py-3 px-4">${f.available_seats_economy}/${f.available_seats_business}/${f.available_seats_first}</td>
                        <td class="py-3 px-4 font-semibold">‚Çπ${f.price_economy.toLocaleString()}</td>
                        <td class="py-3 px-4">
                            <button onclick="deleteFlight(${f.flight_id}, '${f.flight_no}')"
                                    class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Add search functionality
            document.getElementById('flightSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = container.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

        } catch (err) {
            console.error(err);
            container.innerHTML = '<p class="text-center text-red-500 py-8">Error loading flights</p>';
        }
    }

    async function deleteFlight(flightId, flightNo) {
        if (!confirm(`Are you sure you want to delete flight ${flightNo}?\n\nThis cannot be undone!`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/api/flights/${flightId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert('‚úÖ Flight deleted successfully!');
                loadFlights();
            } else {
                alert('‚ùå ' + result.error);
            }
        } catch (err) {
            console.error(err);
            alert('Error deleting flight');
        }
    }

    // ==================== ALL BOOKINGS ====================
    async function loadAllBookings() {
        const container = document.getElementById('bookingsTable');
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Loading bookings...</p>';

        try {
            const response = await fetch('/admin/api/bookings');
            const bookings = await response.json();

            if (!bookings.length) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No bookings found</p>';
                return;
            }

            let html = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4">PNR</th>
                            <th class="text-left py-3 px-4">Passenger</th>
                            <th class="text-left py-3 px-4">Flight</th>
                            <th class="text-left py-3 px-4">Route</th>
                            <th class="text-left py-3 px-4">Date</th>
                            <th class="text-left py-3 px-4">Class</th>
                            <th class="text-left py-3 px-4">Price</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bookings.forEach(b => {
                const bookingDate = new Date(b.booking_date).toLocaleDateString('en-IN');
                const statusClass = b.status === 'Confirmed' ? 'bg-green-100 text-green-800' :
                                   b.status === 'Cancelled' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';

                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4 font-semibold text-red-600">${b.pnr}</td>
                        <td class="py-3 px-4">${b.passenger_name}</td>
                        <td class="py-3 px-4">${b.airline} ${b.flight_no}</td>
                        <td class="py-3 px-4">${b.source_city} ‚Üí ${b.dest_city}</td>
                        <td class="py-3 px-4 text-xs">${bookingDate}</td>
                        <td class="py-3 px-4">${b.class}</td>
                        <td class="py-3 px-4 font-semibold">‚Çπ${b.price.toLocaleString()}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                ${b.status}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            ${b.status === 'Confirmed' ?
                                `<button onclick="cancelBookingAdmin(${b.booking_id}, '${b.pnr}')"
                                        class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                    Cancel
                                </button>` :
                                '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Add search functionality
            document.getElementById('bookingSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = container.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

        } catch (err) {
            console.error(err);
            container.innerHTML = '<p class="text-center text-red-500 py-8">Error loading bookings</p>';
        }
    }

    async function cancelBookingAdmin(bookingId, pnr) {
        if (!confirm(`Cancel booking ${pnr}?`)) return;

        try {
            const response = await fetch(`/admin/api/bookings/${bookingId}/cancel`, {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                alert('‚úÖ Booking cancelled successfully!');
                loadAllBookings();
            } else {
                alert('‚ùå ' + result.error);
            }
        } catch (err) {
            console.error(err);
            alert('Error cancelling booking');
        }
    }

    // ==================== MANAGE USERS ====================
    async function loadUsers() {
        const container = document.getElementById('usersTable');
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Loading users...</p>';

        try {
            const response = await fetch('/admin/api/users');
            const users = await response.json();

            if (!users.length) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No users found</p>';
                return;
            }

            let html = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4">Username</th>
                            <th class="text-left py-3 px-4">Email</th>
                            <th class="text-left py-3 px-4">Phone</th>
                            <th class="text-left py-3 px-4">Air Miles</th>
                            <th class="text-left py-3 px-4">Total Bookings</th>
                            <th class="text-left py-3 px-4">Total Spent</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(u => {
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4 font-semibold">${u.username}</td>
                        <td class="py-3 px-4">${u.email}</td>
                        <td class="py-3 px-4">${u.phone}</td>
                        <td class="py-3 px-4 font-semibold text-red-600">${u.air_miles}</td>
                        <td class="py-3 px-4 text-center">${u.total_bookings}</td>
                        <td class="py-3 px-4 font-semibold">‚Çπ${u.total_spent.toLocaleString()}</td>
                        <td class="py-3 px-4">
                            <button onclick="viewUserDetails(${u.user_id})"
                                    class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Add search functionality
            document.getElementById('userSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = container.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

        } catch (err) {
            console.error(err);
            container.innerHTML = '<p class="text-center text-red-500 py-8">Error loading users</p>';
        }
    }

    async function viewUserDetails(userId) {
        try {
            const response = await fetch(`/admin/api/users/${userId}`);
            const data = await response.json();

            const user = data.user;
            const bookings = data.bookings;

            let html = `
                <div class="grid grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div><span class="font-semibold">Username:</span> ${user.username}</div>
                    <div><span class="font-semibold">Email:</span> ${user.email}</div>
                    <div><span class="font-semibold">Phone:</span> ${user.phone}</div>
                    <div><span class="font-semibold">Air Miles:</span> <span class="text-red-600 font-bold">${user.air_miles}</span></div>
                </div>

                <h4 class="text-lg font-bold mb-4">Booking History (${bookings.length})</h4>
            `;

            if (bookings.length) {
                html += '<div class="space-y-3">';
                bookings.forEach(b => {
                    const statusClass = b.status === 'Confirmed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    html += `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold">PNR: ${b.pnr}</p>
                                    <p class="text-sm text-gray-600">${b.airline} ${b.flight_no}</p>
                                    <p class="text-sm">${b.source} ‚Üí ${b.destination}</p>
                                    <p class="text-xs text-gray-500">${new Date(b.departure_time).toLocaleDateString('en-IN')}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${b.status}</span>
                                    <p class="font-semibold mt-2">‚Çπ${b.price.toLocaleString()}</p>
                                    <p class="text-xs text-gray-500">${b.class}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p class="text-center text-gray-500 py-4">No bookings yet</p>';
            }

            document.getElementById('userModalContent').innerHTML = html;
            document.getElementById('userModal').classList.remove('hidden');

        } catch (err) {
            console.error(err);
            alert('Error loading user details');
        }
    }

    function closeUserModal() {
        document.getElementById('userModal').classList.add('hidden');
    }
</script>
<style>
    .sidebar-link.active {
        background-color: rgba(55, 65, 81, 0.5);
        border-left: 4px solid #ef4444;
    }
</style>

</body>
</html>